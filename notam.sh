#!/bin/bash

# NOTAM Fetcher - –ø–æ–ª—É—á–µ–Ω–∏–µ NOTAM –¥–ª—è –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./notam.sh UHPP

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
WHITE='\033[0;37m'
NC='\033[0m' # No Color

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤
get_airport_info() {
    case $1 in
        "UUEE") echo "–®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ, –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è" ;;
        "UUWW") echo "–í–Ω—É–∫–æ–≤–æ, –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è" ;;
        "UUDD") echo "–î–æ–º–æ–¥–µ–¥–æ–≤–æ, –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è" ;;
        "UHPP") echo "–ï–ª–∏–∑–æ–≤–æ, –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π, –†–æ—Å—Å–∏—è" ;;
        "UHWW") echo "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –†–æ—Å—Å–∏—è" ;;
        "URSS") echo "–°–æ—á–∏, –†–æ—Å—Å–∏—è" ;;
        "USSS") echo "–ö–æ–ª—å—Ü–æ–≤–æ, –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –†–æ—Å—Å–∏—è" ;;
        "UAAA") echo "–ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω" ;;
        "UATT") echo "–ê—Å—Ç–∞–Ω–∞, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω" ;;
        "ZBAA") echo "–ü–µ–∫–∏–Ω –°—Ç–æ–ª–∏—á–Ω—ã–π, –ö–∏—Ç–∞–π" ;;
        "RJAA") echo "–ù–∞—Ä–∏—Ç–∞, –¢–æ–∫–∏–æ, –Ø–ø–æ–Ω–∏—è" ;;
        "KJFK") echo "–ö–µ–Ω–Ω–µ–¥–∏, –ù—å—é-–ô–æ—Ä–∫, –°–®–ê" ;;
        "KLAX") echo "–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å, –°–®–ê" ;;
        "EGLL") echo "–•–∏—Ç—Ä–æ—É, –õ–æ–Ω–¥–æ–Ω, –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è" ;;
        "LFPG") echo "–®–∞—Ä–ª—å-–¥–µ-–ì–æ–ª–ª—å, –ü–∞—Ä–∏–∂, –§—Ä–∞–Ω—Ü–∏—è" ;;
        "EDDF") echo "–§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç-–Ω–∞-–ú–∞–π–Ω–µ, –ì–µ—Ä–º–∞–Ω–∏—è" ;;
        *) echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞ ICAO
is_valid_icao() {
    local icao=$1
    [[ ${#icao} -eq 4 ]] && [[ "$icao" =~ ^[A-Z]{4}$ ]]
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è NOTAM –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ API (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
fetch_notam_public() {
    local icao=$1
    echo -e "${CYAN}üîç –ü–æ–∏—Å–∫ NOTAM –¥–ª—è $icao...${NC}" >&2
    
    # –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    local notam_data=""
    
    # –ò—Å—Ç–æ—á–Ω–∏–∫ 1: AviationAPI (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø)
    notam_data=$(curl -s --connect-timeout 10 \
        "https://api.aviationapi.com/v1/notams/apt?apt=$icao" 2>/dev/null | \
        head -100)
    
    # –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π
    if [[ -z "$notam_data" || "$notam_data" == *"error"* || "$notam_data" == *"null"* ]]; then
        # –ò—Å—Ç–æ—á–Ω–∏–∫ 2: AviationWeather (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        notam_data=$(curl -s --connect-timeout 10 \
            "https://aviationweather.gov/cgi-bin/data/notams.php?format=decoded&ids=$icao" 2>/dev/null | \
            grep -A 5 "$icao" | head -20)
    fi
    
    echo "$notam_data"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ NOTAM –∏–∑ JSON
parse_notam_json() {
    local json_data=$1
    local icao=$2
    
    if command -v jq &> /dev/null; then
        local notam_count=$(echo "$json_data" | jq length 2>/dev/null)
        if [[ $notam_count -gt 0 ]]; then
            echo "$json_data" | jq -r '.[] | "\(.Number): \(.Message)\n–ü–µ—Ä–∏–æ–¥: \(.StartTime) - \(.EndTime)\n"' 2>/dev/null
        else
            echo ""
        fi
    else
        # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ jq
        echo "$json_data" | grep -oP '"Message":"[^"]*"' | sed 's/"Message":"//g' | sed 's/"//g'
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ NOTAM
show_notam_info() {
    local icao=$1
    local airport_info=$(get_airport_info "$icao")
    
    echo -e "${CYAN}=== NOTAM –ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø $icao ===${NC}"
    echo -e "${GREEN}üè¢ –ê—ç—Ä–æ–ø–æ—Ä—Ç: $airport_info${NC}"
    echo -e "${CYAN}üïê –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: $(date)${NC}"
    echo ""
    
    echo -e "${YELLOW}üìä –°—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω–∏—è NOTAM:${NC}"
    echo -e "${RED}‚ùå –†–µ–∞–ª—å–Ω—ã–µ NOTAM –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ API${NC}"
    echo ""
    
    echo -e "${CYAN}üí° –ü–æ—á–µ–º—É NOTAM –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:${NC}"
    echo -e "${WHITE}‚Ä¢ NOTAM –∑–∞—â–∏—â–µ–Ω—ã –∞–≤—Ç–æ—Ä—Å–∫–∏–º –ø—Ä–∞–≤–æ–º${NC}"
    echo -e "${WHITE}‚Ä¢ –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö${NC}"
    echo -e "${WHITE}‚Ä¢ –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ API –ø–ª–∞—Ç–Ω—ã–µ –∏–ª–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏${NC}"
    echo ""
    
    echo -e "${GREEN}üöÄ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è NOTAM:${NC}"
    echo ""
    
    echo -e "${YELLOW}üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –≤–µ–±-—Å–∞–π—Ç—ã:${NC}"
    echo -e "${WHITE}‚Ä¢ FAA (–°–®–ê): https://notams.aim.faa.gov/notamSearch/${NC}"
    echo -e "${WHITE}‚Ä¢ Eurocontrol (–ï–≤—Ä–æ–ø–∞): https://www.eurocontrol.int/notams${NC}"
    echo -e "${WHITE}‚Ä¢ –†–æ—Å—Å–∏—è: https://www.caiga.ru/ (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)${NC}"
    echo ""
    
    echo -e "${YELLOW}üì± –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:${NC}"
    echo -e "${WHITE}‚Ä¢ ForeFlight (iOS)${NC}"
    echo -e "${WHITE}‚Ä¢ Garmin Pilot (iOS/Android)${NC}"
    echo -e "${WHITE}‚Ä¢ SkyDemon (Windows/iOS/Android)${NC}"
    echo -e "${WHITE}‚Ä¢ AirMate (iOS)${NC}"
    echo ""
    
    echo -e "${YELLOW}üíª –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ:${NC}"
    echo -e "${WHITE}‚Ä¢ Little Navmap (–±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ)${NC}"
    echo -e "${WHITE}‚Ä¢ SimBrief (–≤–µ–±-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)${NC}"
    echo -e "${WHITE}‚Ä¢ Navigraph (–ø–æ–¥–ø–∏—Å–∫–∞)${NC}"
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ç–∏–ø–∏—á–Ω—ã—Ö NOTAM –¥–ª—è —ç—Ç–æ–≥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞
    show_sample_notam "$icao"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ NOTAM
show_sample_notam() {
    local icao=$1
    
    echo -e "${CYAN}üìã –ü—Ä–∏–º–µ—Ä—ã —Ç–∏–ø–∏—á–Ω—ã—Ö NOTAM –¥–ª—è $icao:${NC}"
    echo ""
    
    case $icao in
        UHPP|UHWW|URSS)
            # –†–æ—Å—Å–∏–π—Å–∫–∏–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã
            echo -e "${GREEN}‚Ä¢ –í–ü–ü 10/28 –∑–∞–∫—Ä—ã—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç${NC}"
            echo -e "  –ü–µ—Ä–∏–æ–¥: 270800Z - 271800Z"
            echo ""
            echo -e "${GREEN}‚Ä¢ –°–Ω–∏–∂–µ–Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –†–õ–°${NC}"
            echo -e "  –ü–µ—Ä–∏–æ–¥: 270000Z - 272400Z"
            echo ""
            echo -e "${GREEN}‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≤—ã—Ö–æ–¥–∞${NC}"
            echo -e "  –ü–µ—Ä–∏–æ–¥: 271200Z - 271600Z"
            ;;
        UUEE|UUWW|UUDD)
            # –ú–æ—Å–∫–æ–≤—Å–∫–∏–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã
            echo -e "${GREEN}‚Ä¢ –†–µ–º–æ–Ω—Ç —Å–≤–µ—Ç–æ—Å–∏–≥–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è${NC}"
            echo -e "  –ü–µ—Ä–∏–æ–¥: 270600Z - 272000Z"
            echo ""
            echo -e "${GREEN}‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –ø—Ä–æ–ª–µ—Ç–∞${NC}"
            echo -e "  –ü–µ—Ä–∏–æ–¥: 271000Z - 271400Z"
            ;;
        KJFK|KLAX)
            # –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã
            echo -e "${GREEN}‚Ä¢ RWY 13L/31R CLSD FOR MAINT${NC}"
            echo -e "  PERIOD: 270800Z - 271800Z"
            echo ""
            echo -e "${GREEN}‚Ä¢ TWR FREQ 118.7 TEMPORARY U/S${NC}"
            echo -e "  USE 121.5 EMERGENCY ONLY"
            ;;
        EGLL|LFPG|EDDF)
            # –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã
            echo -e "${GREEN}‚Ä¢ ILS CAT II/III U/S${NC}"
            echo -e "  PERIOD: 270900Z - 271700Z"
            echo ""
            echo -e "${GREEN}‚Ä¢ ATC STRIKE - REDUCED SERVICE${NC}"
            echo -e "  PERIOD: 271200Z - 271600Z"
            ;;
        *)
            # –û–±—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã
            echo -e "${GREEN}‚Ä¢ –í–ü–ü –∑–∞–∫—Ä—ã—Ç–∞ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è${NC}"
            echo -e "${GREEN}‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º –¥–≤–∏–∂–µ–Ω–∏—è${NC}"
            echo -e "${GREEN}‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—ã—Å–æ—Ç–µ/–º–∞—Ä—à—Ä—É—Ç–∞–º${NC}"
            echo -e "${GREEN}‚Ä¢ –†–∞–±–æ—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è${NC}"
            ;;
    esac
    echo ""
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ curl
    if ! command -v curl &> /dev/null; then
        echo -e "${YELLOW}‚ùå –û—à–∏–±–∫–∞: curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ curl:"
        echo "  macOS: brew install curl"
        echo "  Linux: sudo apt install curl"
        exit 1
    fi
    
    if [[ $# -eq 0 ]]; then
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–¥ ICAO]"
        echo "–ü—Ä–∏–º–µ—Ä: $0 UHPP"
        echo ""
        echo "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–¥—ã:"
        echo "  UUEE - –®–µ—Ä–µ–º–µ—Ç—å–µ–≤–æ, –ú–æ—Å–∫–≤–∞"
        echo "  UUWW - –í–Ω—É–∫–æ–≤–æ, –ú–æ—Å–∫–≤–∞" 
        echo "  UHWW - –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫"
        echo "  UHPP - –ï–ª–∏–∑–æ–≤–æ, –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π"
        echo "  URSS - –°–æ—á–∏"
        echo "  KJFK - –ö–µ–Ω–Ω–µ–¥–∏, –ù—å—é-–ô–æ—Ä–∫"
        echo "  EGLL - –•–∏—Ç—Ä–æ—É, –õ–æ–Ω–¥–æ–Ω"
        exit 1
    fi
    
    local icao=$1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞ ICAO
    if ! is_valid_icao "$icao"; then
        echo -e "${YELLOW}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ ICAO: $icao${NC}"
        echo "–ö–æ–¥ ICAO –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –±—É–∫–≤"
        exit 1
    fi
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    show_notam_info "$icao"
    
    # –í—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ API –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç)
    local notam_data=$(fetch_notam_public "$icao")
    if [[ -n "$notam_data" && "$notam_data" != *"error"* && "$notam_data" != *"null"* ]]; then
        echo -e "${GREEN}üéâ –£–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:${NC}"
        echo ""
        if command -v jq &> /dev/null; then
            parse_notam_json "$notam_data" "$icao"
        else
            echo "$notam_data" | head -10
        fi
        echo ""
    fi
    
    echo -e "${CYAN}===============================${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  –í–∞–∂–Ω–æ: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ NOTAM –ø–µ—Ä–µ–¥ –ø–æ–ª–µ—Ç–æ–º!${NC}"
    echo -e "${YELLOW}   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.${NC}"
}

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
main "$@"